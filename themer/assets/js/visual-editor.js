!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self)["visual-editor"]=t()}(this,(function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t,o={};return e(function(){if(t)return o;function e(){this._page_modules={};var e=this;this.loaded=0,this.is_theme="undefined"!=typeof _panel_options&&"module"===_panel_options.type,this._options=this.is_theme?_panel_options:_plugins_options[0],this.onMessage((function(t){if(t.data&&t.data.type)switch(t.data.type){case"iframe-loaded":t.data.pid&&(e.pid=t.data.pid),e.postMessage({type:"modules",preID:e.preID?e.preID:0}),e.renderModules(),e.notice("\u5f00\u59cb\u521d\u59cb\u5316\u6a21\u5757\u5de5\u5177"),e.preID=0;break;case"iframe-reload":e.iframeLoading();break;case"wpcom-tool-loaded":e.iframeLoaded();var o=e.loaded?"\u52a0\u8f7d\u5b8c\u6210":"All done! \u6b22\u8fce\u4f7f\u7528\u53ef\u89c6\u5316\u7f16\u8f91\u5668";e.notice(o,"success",2e3),e.loaded=1,jQuery(".ve-header-submit").removeClass("loading");break;case"wpcom-panel":e.editModule(t.data.module,t.data.parent);break;case"close-wpcom-panel":jQuery("#wpcom-panel").removeClass("active"),jQuery(".mod-item").trigger("mouseleave");break;case"close-module-list":jQuery(".ve-header-add, #ve-modules").removeClass("active");break;case"save-module":var i=Object.assign({},t.data.module);e._module=t.data.module,i.type="save-module",i.options={},e.editModule(i)}})),this.init()}return t=1,e.prototype={init:function(){var e=this;this.iframeLoading(),jQuery(document).on("click",".j-modal-close",(function(){jQuery("#wpcom-panel").removeClass("active")})).on("click",".ve-header-add",(function(){jQuery("#ve-modules").length&&jQuery(".ve-header-add, #ve-modules").toggleClass("active")})).on("click",".ve-header-setting",(function(){var t=jQuery("#wpcom-panel");e.module&&"page-setting"===e.module.type&&t.hasClass("active")?t.removeClass("active"):e.editModule({type:"page-setting",settings:e._options.settings})})).on("click",".ve-header-platform",(function(){var t=jQuery("#wpcom-panel");e.module&&"platform-setting"===e.module.type&&t.hasClass("active")?t.removeClass("active"):e.editModule({type:"platform-setting",settings:e._options.settings})})).on("click",".j-modal-submit",(function(){var t=jQuery(this);if(t.hasClass("loading"))return!1;var o=t.text();t.text(t.data("loading-text")).addClass("loading").data("text",o),"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave();var i=jQuery("#wpcom-panel").find("form.wpcom-modal-body").serialize().replace(/\'/g,"%27").replace(/\+/g,"%20");i=e.dataFilter(i);var a="";if("save-module"===e.module.type)e.saveToMyModule(i,(function(){t.removeClass("loading").text(t.data("text"))}));else if("page-setting"===e.module.type)e.saveSetting(i,(function(){t.removeClass("loading").text(t.data("text"))})),a="\u6b63\u5728\u63d0\u4ea4\u9884\u89c8\u9875\u9762\u8bbe\u7f6e...";else{if("platform-setting"===e.module.type)return e._options.settings.platform=i.platform,e.postMessage({type:"platform",platform:i.platform}),e.notice("\u5e73\u53f0\u5207\u6362\u6210\u529f\uff01","success",2e3),t.removeClass("loading").text(t.data("text")),jQuery("#wpcom-panel").removeClass("active"),!1;e.saveModule(i,(function(){t.removeClass("loading").text(t.data("text"))})),a="\u6b63\u5728\u63d0\u4ea4\u9884\u89c8\u6a21\u5757\u8bbe\u7f6e..."}a&&e.notice(a),window.onbeforeunload=function(){return"\u786e\u5b9a\u79bb\u5f00\u5f53\u524d\u9875\u9762\u5417\uff1f"}})).on("click",".ve-header-mobile",(function(){jQuery(".ve-header-pc").removeClass("active"),jQuery(this).addClass("active"),jQuery(".ve-iframe-inner").addClass("mobile"),jQuery(document).trigger("setDevice",["mobile"])})).on("click",".ve-header-pc",(function(){jQuery(".ve-header-mobile").removeClass("active"),jQuery(this).addClass("active"),jQuery(".ve-iframe-inner").removeClass("mobile"),jQuery(document).trigger("setDevice",["pc"])})).on("click",".ve-header-submit",(function(){var t=jQuery(this);if(t.hasClass("loading"))return!1;e.iframeLoading(),t.addClass("loading"),e.notice("\u6b63\u5728\u63d0\u4ea4\u66f4\u65b0\u53d1\u5e03..."),jQuery.ajax({type:"POST",url:ajaxurl,data:{action:e.is_theme?"wpcom_ve_save":"wwa_ve_save",id:e.pid,data:JSON.stringify(e.getData(e.pid)),settings:JSON.stringify(e._options.settings),nonce:jQuery("#ve-nonce").val()},dataType:"json"}).then((function(o){e.iframeLoaded(),t.removeClass("loading"),window.onbeforeunload=null,e.notice(o.msg,0==o.result?"success":"error",2e3)}),(function(){e.notice("\u63d0\u4ea4\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01","error",2e3),e.iframeLoaded(),t.removeClass("loading")}))}))},iframeLoaded:function(){var e=document.getElementsByClassName("ve-loading");e.length&&e[0].classList.remove("active")},iframeLoading:function(){var e=document.getElementsByClassName("ve-loading");e.length&&e[0].classList.add("active")},renderModules:function(){if(document.getElementById("ve-modules"))return!1;var e=this,t=document.createElement("div");t.id="ve-modules";var o=document.createElement("div");o.classList.add("mod-wrap");var i="";if(_modules)for(var a in _modules){var s=_modules[a];if(s&&s.name){s.icon=s.icon?s.icon:"gear";var n=s.icon.split(":"),d='<i class="mod-item-icon material-icons">'+s.icon+"</i>";n&&n[1]&&"mti"===n[0]&&(d='<i class="mod-item-icon material-icons">'+n[1]+"</i>"),i+='<div class="mod-item" data-type="'+a+'">'+d+s.name+"</div>"}}o.innerHTML=i,t.appendChild(o),document.body.appendChild(t);var r=null;jQuery(t).on("mouseenter",".mod-item",(function(){r&&clearTimeout(r);var t=jQuery(this);r=setTimeout((function(){var o=t.data("type");if(o&&void 0!==_modules[o]&&void 0!==_modules[o].thumb){var i=document.querySelector(".mod-preview");i||((i=document.createElement("div")).classList.add("mod-preview"),document.body.appendChild(i));var a=_modules[o].thumb?_modules[o].thumb:"";a=a&&!a.match(/^(http:\/\/|https:\/\/|\/\/)/i)?'<img src="'+(a="//demo.wpcom.cn/preview/options"+(e._options.assets_ver?e._options.assets_ver:"")+a)+'">':a?'<img src="'+a+'">':'<div class="mod-preview-null">\u6682\u65e0\u9884\u89c8</div>',i.innerHTML="<h3>\u6a21\u5757\u9884\u89c8</h3>"+a,i.classList.add("active")}}),300)})).on("mouseleave",".mod-item",(function(){r&&clearTimeout(r);var e=document.querySelector(".mod-preview");e&&e.classList.remove("active")}))},editModule:function(e,t){var o=this,i=jQuery("#wpcom-panel");this.module=e,this._parent=t,this._open_timer&&clearTimeout(this._open_timer),i.hasClass("active")?(i.removeClass("active"),setTimeout((function(){o.type=e.type,i.trigger("module.edit",e).addClass("active"),o._open_timer=setTimeout((function(){jQuery(".wpcom-modal-body .wpcom-module-content").scrollTop(0)}),100)}),200)):(this.type=e.type,i.trigger("module.edit",e).addClass("active"),this._open_timer=setTimeout((function(){jQuery(".wpcom-modal-body .wpcom-module-content").scrollTop(0)}),100))},saveModule:function(e,t){if("my-module"===this.module.type){var o=this;jQuery.ajax({type:"POST",url:ajaxurl,data:{action:this.is_theme?"wpcom_get_module":"wwa_get_module",id:e.mid,mid:this.module.id},dataType:"json"}).then((function(i){if(i.data){var a=1,s={fullwidth:"\u5168\u5bbd\u6a21\u5757",container:"\u5bb9\u5668\u6a21\u5757","sidebar-layout":"\u8fb9\u680f\u5e03\u5c40\u6a21\u5757",grid:"\u6805\u683c\u6a21\u5757",tabs:"\u9009\u9879\u5361\u6a21\u5757"};for(var n in i.data)if(o._parent&&s[i.data[n].type]){var d=3===o._parent?"\u9009\u9879\u5361\u6a21\u5757":2===o._parent?"\u6805\u683c\u6a21\u5757":"\u5176\u4ed6\u6a21\u5757\uff08\u5982\u5168\u5bbd\u3001\u6805\u683c\u6a21\u5757\uff09",r="\u5d4c\u5957\u9519\u8bef\uff1a\u672c\u6b21\u6dfb\u52a0\u7684\u6a21\u5757\u542b\u6709"+s[i.data[n].type]+"\uff0c\u800c\u76ee\u6807\u4f4d\u7f6e\u5904\u4e8e"+d+"\u5185\uff01";o.notice(r,"error",3e3),a=0,o.postMessage({type:"remove-module",module:o.module.id}),jQuery("#wpcom-panel").removeClass("active"),void 0!==t&&t();break}a&&"1"==e.type?(i.data[0].id=o.module.id,o.postMessage({type:"insert-module",modules:i.data,target:o.module.id}),setTimeout((function(){void 0!==t&&t(),setTimeout((function(){jQuery("#wpcom-panel").removeClass("active")}),200)}),300)):a&&o._saveModule(e,t)}else 0!=e.result&&o.notice("\u6a21\u5757\u83b7\u53d6\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01","error",2e3)}),(function(){o.notice("\u6a21\u5757\u83b7\u53d6\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01","error",2e3)}))}else this._saveModule(e,t)},_saveModule:function(e,t){var o=this.getData(this.pid),i=this;this.module.options.modules?e.modules=this.module.options.modules:this.module.options.grids?e.grids=this.module.options.grids:"tabs"===this.module.type&&this.module.options.tabs&&(e.tabs=this.module.options.tabs),this.module=Object.assign(this.module,{settings:e});var a=this.updateModules(this.module,o);a&&this.setData(this.pid,a,(function(){i.preID=i.module.id,i.postMessage({type:"preview"}),setTimeout((function(){void 0!==t&&t(),setTimeout((function(){jQuery("#wpcom-panel").removeClass("active")}),200)}),400)}))},saveToMyModule:function(e,t){var o=0,i=this;""===e.title&&(o=1,jQuery("#wpcom_title").addClass("err").off("change.save").on("change.save",(function(){jQuery(this).removeClass("err")}))),""===e.type&&(o=1,jQuery("#wpcom_type > div").addClass("err").parent().parent().find('input[name="type"]').off("change.save").on("change.save",(function(){jQuery("#wpcom_type > div").removeClass("err")}))),o?void 0!==t&&t():(this.notice("\u6b63\u5728\u63d0\u4ea4\u4fdd\u5b58\u6211\u7684\u6a21\u5757..."),jQuery.ajax({type:"POST",url:ajaxurl,data:{action:this.is_theme?"wpcom_save_module":"wwa_save_module",title:e.title,desc:e.desc,module:JSON.stringify(this._module)},dataType:"json"}).then((function(o){if(o.id){var a=_modules["my-module"];if(a.options[0].mid&&(a.options[0].mid.options?a.options[0].mid.options[o.id]=o.title:a.options[0].mid.o&&(a.options[0].mid.o[o.id]=o.title)),"0"==e.type){var s=i.updateModules({type:"my-module",settings:{mid:o.id,type:0},id:i._module.id},i.getData(i.pid));s&&i.setData(i.pid,s,(function(){i.postMessage({type:"preview"})}))}}else 0!=o.result&&i.notice("\u6a21\u5757\u4fdd\u5b58\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01","error",2e3);void 0!==t&&t(),i.notice("\u6a21\u5757\u4fdd\u5b58\u6210\u529f\uff01","success",2e3),setTimeout((function(){jQuery("#wpcom-panel").removeClass("active")}),200)}),(function(){void 0!==t&&t()})))},saveSetting:function(e,t){this._options.settings=e,this.postMessage({type:"preview"}),setTimeout((function(){void 0!==t&&t(),setTimeout((function(){jQuery("#wpcom-panel").removeClass("active")}),200)}),400)},setData:function(e,t,o){t="string"==typeof t?JSON.parse(t):t,this._page_modules=this._page_modules?this._page_modules:{},this._page_modules[e]=Object.assign([],t),void 0!==o&&o()},getData:function(e){return void 0===e?this._page_modules:this._page_modules[e]},dataFilter:function(e){var t={},o={},i=Object.assign([],_modules[this.type].options),a=[];i[0]&&i[0]["tab-name"]?a=i:a.push(Object.assign({},_modules[this.type].options)),e=e.split("&");for(var s=0;s<e.length;s++){var n=e[s].split("="),d=decodeURIComponent(n[0]).match(/(\S+)\[\]$/i);d&&d[1]?(t[d[1]]||(t[d[1]]=[]),t[d[1]].push(decodeURIComponent(n[1]))):t[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}for(var r=0;r<a.length;r++)o=this.optionsFilter(a[r],o,t);return o},optionsFilter:function(e,t,o){for(var i in e)if("tab-name"!==i)if(e[i].type=e[i].t?e[i].t:e[i].type,"repeat"===e[i].type||"rp"===e[i].type){t[i]=[];var a=e[i].o?e[i].o:e[i].options?e[i].options:e[i].items;for(var s in a)if("wrapper"===a[s].type||"w"===a[s].type){var n=a[s].o?a[s].o:a[s].options?a[s].options:a[s].items;for(var d in n)for(var r in o){var l=r.match(/(\S+)\[(\d+)\]/i);l&&l[1]==d&&(t[i][l[2]]||(t[i][l[2]]={}),t[i][l[2]][d]=o[r])}}else if("repeat"===a[s].type||"rp"===a[s].type){var u=a[s].o?a[s].o:a[s].options?a[s].options:a[s].items;for(var m in u)for(var c in o){var p=c.match(/(\S+)\[(\d+)\]\[(\d+)\]/i);p&&p[1]==m&&(t[i][p[2]]||(t[i][p[2]]={}),t[i][p[2]][s]||(t[i][p[2]][s]=[]),t[i][p[2]][s][p[3]]||(t[i][p[2]][s][p[3]]={}),t[i][p[2]][s][p[3]][m]=o[c])}}else for(var v in o){var f=v.match(/(\S+)\[(\d+)\]/i);f&&f[1]==s&&(t[i][f[2]]||(t[i][f[2]]={}),t[i][f[2]][s]=o[v])}}else if("wrapper"===e[i].type||"w"===e[i].type){var g=e[i].o?e[i].o:e[i].options?e[i].options:e[i].items;t=this.optionsFilter(g,t,o)}else void 0!==o[i]&&(e[i].mobile?(t[i]=void 0!==o[i+"__pc"]?o[i+"__pc"]:o[i],void 0!==o[i+"__mobile"]&&(t[i+"_mobile"]=o[i+"__mobile"])):t[i]=o[i]);return t},updateModules:function(e,t){if(t)for(var o=0;o<t.length;o++){if(t[o].id==e.id){t[o]=e;break}if(t[o]&&t[o].settings){var i="";if(t[o].settings.grids?i="grids":t[o].settings.modules?i="modules":"tabs"===t[o].type&&(i="tabs"),"modules"===i&&t[o].settings[i])t[o].settings[i]=this.updateModules(e,Object.assign([],t[o].settings[i]));else if(("grids"===i||"tabs"===i)&&t[o].settings[i])for(var a in t[o].settings[i])t[o].settings[i][a]=this.updateModules(e,Object.assign([],t[o].settings[i][a]))}}return t},postMessage:function(e,t){(t=void 0!==t?t:document.getElementById("ve-iframe").contentWindow).postMessage(JSON.parse(JSON.stringify(e)),"*")},onMessage:function(e,t){void 0===t&&"function"==typeof e&&(t=e,e=window),e.addEventListener("message",(function(e){if(e.origin!==window.location.origin)return!1;t&&"function"==typeof t&&t(e)}),!1)},notice:function(e,t,o){var i=jQuery("#ve-notice"),a="",s=this;switch(i.removeClass("active"),this.nTimer&&clearTimeout(this.nTimer),t){case"success":a='<i class="material-icons success">&#xe92d;</i>';break;case"error":a='<i class="material-icons error">&#xe001;</i>';break;default:a='<svg class="ve-notice-loading-svg" viewBox="0 0 1024 1024"><path d="M512 85.333333a42.666667 42.666667 0 0 1 42.666667 42.666667v128a42.666667 42.666667 0 0 1-85.333334 0V128a42.666667 42.666667 0 0 1 42.666667-42.666667z m0 640a42.666667 42.666667 0 0 1 42.666667 42.666667v128a42.666667 42.666667 0 0 1-85.333334 0v-128a42.666667 42.666667 0 0 1 42.666667-42.666667z m426.666667-213.333333a42.666667 42.666667 0 0 1-42.666667 42.666667h-128a42.666667 42.666667 0 0 1 0-85.333334h128a42.666667 42.666667 0 0 1 42.666667 42.666667zM298.666667 512a42.666667 42.666667 0 0 1-42.666667 42.666667H128a42.666667 42.666667 0 0 1 0-85.333334h128a42.666667 42.666667 0 0 1 42.666667 42.666667z m515.029333 301.696a42.666667 42.666667 0 0 1-60.330667 0l-90.496-90.496a42.666667 42.666667 0 0 1 60.330667-60.330667l90.496 90.453334a42.666667 42.666667 0 0 1 0 60.373333zM361.130667 361.130667a42.666667 42.666667 0 0 1-60.330667 0l-90.453333-90.453334a42.666667 42.666667 0 0 1 60.330666-60.373333l90.453334 90.496a42.666667 42.666667 0 0 1 0 60.330667zM210.346667 813.696a42.666667 42.666667 0 0 1 0-60.330667l90.496-90.496a42.666667 42.666667 0 1 1 60.330666 60.330667l-90.453333 90.496a42.666667 42.666667 0 0 1-60.373333 0zM662.869333 361.130667a42.666667 42.666667 0 0 1 0-60.330667l90.453334-90.496a42.666667 42.666667 0 0 1 60.373333 60.330667L723.2 361.130667a42.666667 42.666667 0 0 1-60.330667 0z"></path></svg>'}var n='<span class="ve-notice-icon">'+a+"</span>";n+="<span>"+e+"</span>",setTimeout((function(){i.html(n).addClass("active"),o&&(s.nTimer=setTimeout((function(){i.html(n).removeClass("active")}),o))}),270)}},window.VE=new e,setTimeout((function(){VE.notice("\u5f00\u59cb\u52a0\u8f7d\u7f16\u8f91\u533a\u9875\u9762")}),300),o}())}));
